{% extends "admin/base_site.html" %}
{% load static %}
{% load admin_interface_tags %}

{% block title %}å……ç”µé˜Ÿåˆ—çŠ¶æ€æ€»è§ˆ{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    /* é€‚é…admin-interfaceçš„æ ·å¼ */
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: var(--body-bg, #fff);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 6px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--primary, #417690);
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: var(--body-quiet-color, #666);
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .queue-section {
        background: var(--body-bg, #fff);
        border: 1px solid var(--border-color, #ddd);
        border-radius: 6px;
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .queue-header {
        background: var(--darkened-bg, #f8f9fa);
        padding: 15px;
        border-bottom: 1px solid var(--border-color, #ddd);
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--body-fg, #333);
    }
    
    .queue-content {
        padding: 20px;
    }
    
    .external-queue {
        background: rgba(65, 118, 144, 0.1);
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid var(--primary, #417690);
    }
    
    .pile-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
    }
    
    .pile-card {
        border: 1px solid var(--border-color, #ddd);
        border-radius: 6px;
        overflow: hidden;
        background: var(--body-bg, #fff);
    }
    
    .pile-header {
        padding: 12px 15px;
        font-weight: 600;
        color: white;
        font-size: 0.95rem;
    }
    
    .pile-header.working {
        background: #28a745;
    }
    
    .pile-header.idle {
        background: var(--primary, #417690);
    }
    
    .pile-header.fault {
        background: #dc3545;
    }
    
    .pile-body {
        padding: 15px;
        background: var(--darkened-bg, #fafafa);
    }
    
    .queue-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .queue-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background: var(--body-bg, white);
        border-radius: 4px;
        border-left: 3px solid var(--primary, #417690);
        font-size: 0.9rem;
    }
    
    .queue-item.charging {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }
    
    .refresh-btn {
        background: var(--primary, #417690);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-bottom: 15px;
        transition: background-color 0.3s ease;
    }
    
    .refresh-btn:hover {
        background: var(--primary-hover, #365a6e);
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .timestamp {
        color: var(--body-quiet-color, #666);
        font-size: 0.85rem;
        margin-bottom: 15px;
        font-style: italic;
    }
    
    .section-title {
        color: var(--body-fg, #333);
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .dashboard-stats {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .pile-grid {
            grid-template-columns: 1fr;
        }
        
        .queue-content {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <h1 style="color: var(--body-fg, #333); margin-bottom: 20px;">âš¡ å……ç”µé˜Ÿåˆ—çŠ¶æ€æ€»è§ˆ</h1>

    <button class="refresh-btn" onclick="refreshQueueStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>

    <div class="timestamp" id="lastUpdate">
        æœ€åæ›´æ–°: {{ "now"|date:"Y-m-d H:i:s" }}
    </div>

    <!-- ç³»ç»Ÿç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_piles }}</div>
            <div class="stat-label">æ€»å……ç”µæ¡©æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.working_piles }}</div>
            <div class="stat-label">ä½¿ç”¨ä¸­</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.fault_piles }}</div>
            <div class="stat-label">æ•…éšœæ¡©</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_waiting }}</div>
            <div class="stat-label">æ€»ç­‰å¾…æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.external_waiting }}</div>
            <div class="stat-label">å¤–éƒ¨ç­‰å€™åŒº</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.pile_queue_waiting }}</div>
            <div class="stat-label">æ¡©é˜Ÿåˆ—ç­‰å¾…</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_charging }}</div>
            <div class="stat-label">æ­£åœ¨å……ç”µ</div>
        </div>
    </div>

    <!-- å¿«å……é˜Ÿåˆ—çŠ¶æ€ -->
    <div class="queue-section" id="fast-queue-section">
        <div class="queue-header">âš¡ å¿«å……é˜Ÿåˆ—çŠ¶æ€</div>
        <div class="queue-content">
            <!-- å¤–éƒ¨ç­‰å€™åŒº -->
            <div class="external-queue">
                <h3 class="section-title">ğŸšª å¤–éƒ¨ç­‰å€™åŒº ({{ fast_status.fast.external_waiting.count }}äºº)</h3>
                {% if fast_status.fast.external_waiting.queue_list %}
                    <ul class="queue-list">
                        {% for req in fast_status.fast.external_waiting.queue_list %}
                        <li class="queue-item">
                            <strong>{{ req.position }}ä½:</strong> {{ req.queue_number }} 
                            <small>(é¢„è®¡ç­‰å¾…{{ req.estimated_wait_time }}åˆ†é’Ÿ)</small>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p style="color: var(--body-quiet-color, #666); font-style: italic;">å¤–éƒ¨ç­‰å€™åŒºä¸ºç©º</p>
                {% endif %}
            </div>
            
            <!-- å……ç”µæ¡©è¯¦æƒ… -->
            <h3 class="section-title">ğŸ”Œ å……ç”µæ¡©çŠ¶æ€</h3>
            <div class="pile-grid">
                {% for pile in fast_status.fast.piles %}
                <div class="pile-card">
                    <div class="pile-header {% if pile.is_working %}working{% else %}idle{% endif %}">
                        {{ pile.pile_id }}
                        {% if pile.is_working %}(ä½¿ç”¨ä¸­){% else %}(ç©ºé—²){% endif %}
                    </div>
                    <div class="pile-body">
                        {% if pile.current_charging.queue_number %}
                            <div class="queue-item charging">
                                <strong>æ­£åœ¨å……ç”µ:</strong> {{ pile.current_charging.queue_number }}<br>
                                <strong>è¿›åº¦:</strong> {{ pile.current_charging.progress|floatformat:1 }}%
                            </div>
                        {% endif %}
                        
                        <p><strong>é˜Ÿåˆ—:</strong> {{ pile.queue_count }}/{{ pile.max_queue_size }}</p>
                        <p><strong>é¢„è®¡å‰©ä½™:</strong> {{ pile.estimated_remaining_time }}åˆ†é’Ÿ</p>
                        
                        {% if pile.queue_list %}
                            <ul class="queue-list">
                                {% for req in pile.queue_list %}
                                <li class="queue-item">
                                    <strong>{{ req.position }}ä½:</strong> {{ req.queue_number }}<br>
                                    <small>ç­‰å¾…{{ req.estimated_wait_time }}åˆ†é’Ÿ</small>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="color: var(--body-quiet-color, #666); font-style: italic; font-size: 0.9rem;">é˜Ÿåˆ—ä¸ºç©º</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- æ…¢å……é˜Ÿåˆ—çŠ¶æ€ -->
    <div class="queue-section" id="slow-queue-section">
        <div class="queue-header">ğŸŒ æ…¢å……é˜Ÿåˆ—çŠ¶æ€</div>
        <div class="queue-content">
            <!-- å¤–éƒ¨ç­‰å€™åŒº -->
            <div class="external-queue">
                <h3 class="section-title">ğŸšª å¤–éƒ¨ç­‰å€™åŒº ({{ slow_status.slow.external_waiting.count }}äºº)</h3>
                {% if slow_status.slow.external_waiting.queue_list %}
                    <ul class="queue-list">
                        {% for req in slow_status.slow.external_waiting.queue_list %}
                        <li class="queue-item">
                            <strong>{{ req.position }}ä½:</strong> {{ req.queue_number }} 
                            <small>(é¢„è®¡ç­‰å¾…{{ req.estimated_wait_time }}åˆ†é’Ÿ)</small>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p style="color: var(--body-quiet-color, #666); font-style: italic;">å¤–éƒ¨ç­‰å€™åŒºä¸ºç©º</p>
                {% endif %}
            </div>
            
            <!-- å……ç”µæ¡©è¯¦æƒ… -->
            <h3 class="section-title">ğŸ”Œ å……ç”µæ¡©çŠ¶æ€</h3>
            <div class="pile-grid">
                {% for pile in slow_status.slow.piles %}
                <div class="pile-card">
                    <div class="pile-header {% if pile.is_working %}working{% else %}idle{% endif %}">
                        {{ pile.pile_id }}
                        {% if pile.is_working %}(ä½¿ç”¨ä¸­){% else %}(ç©ºé—²){% endif %}
                    </div>
                    <div class="pile-body">
                        {% if pile.current_charging.queue_number %}
                            <div class="queue-item charging">
                                <strong>æ­£åœ¨å……ç”µ:</strong> {{ pile.current_charging.queue_number }}<br>
                                <strong>è¿›åº¦:</strong> {{ pile.current_charging.progress|floatformat:1 }}%
                            </div>
                        {% endif %}
                        
                        <p><strong>é˜Ÿåˆ—:</strong> {{ pile.queue_count }}/{{ pile.max_queue_size }}</p>
                        <p><strong>é¢„è®¡å‰©ä½™:</strong> {{ pile.estimated_remaining_time }}åˆ†é’Ÿ</p>
                        
                        {% if pile.queue_list %}
                            <ul class="queue-list">
                                {% for req in pile.queue_list %}
                                <li class="queue-item">
                                    <strong>{{ req.position }}ä½:</strong> {{ req.queue_number }}<br>
                                    <small>ç­‰å¾…{{ req.estimated_wait_time }}åˆ†é’Ÿ</small>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="color: var(--body-quiet-color, #666); font-style: italic; font-size: 0.9rem;">é˜Ÿåˆ—ä¸ºç©º</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function refreshQueueStatus() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const sections = document.querySelectorAll('.queue-section');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    refreshBtn.classList.add('loading');
    refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
    sections.forEach(section => section.classList.add('loading'));
    
    fetch('refresh/')
        .then(response => response.json())
        .then(data => {
            // æ›´æ–°æ—¶é—´æˆ³
            document.getElementById('lastUpdate').textContent = 
                'æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN');
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®
            location.reload();
        })
        .catch(error => {
            console.error('åˆ·æ–°å¤±è´¥:', error);
            alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        })
        .finally(() => {
            // æ¢å¤æ­£å¸¸çŠ¶æ€
            refreshBtn.classList.remove('loading');
            refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°çŠ¶æ€';
            sections.forEach(section => section.classList.remove('loading'));
        });
}

// è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
setInterval(refreshQueueStatus, 30000);
</script>
{% endblock %} 